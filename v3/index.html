<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather & Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<style>
:root {
  --bg: #0f0f0f;
  --panel: #1a1a1a;
  --border: #444; /* slightly lighter to enhance grid visibility */
  --text: #ffffff;
  --muted: #e6e6e6;
  --accent: #860038;
  --gap: 8px;
  --footer-height: 36px;
}

html, body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: Arial, sans-serif;
  min-height: 100vh;
  overflow-y: auto;
}

* {
  box-sizing: border-box;
}

body {
  display: flex;
  flex-direction: column;
}

/* HEADER */
.header-bar {
  display: grid;
  grid-template-columns: 1fr 1fr;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
}

.header-title {
  font-size: 18px;
  font-weight: 700;
}

.header-meta {
  font-size: 12px;
  color: var(--muted);
}

.header-controls {
  font-size: 12px;
  color: var(--accent);
}

.header-controls span {
  cursor: pointer;
}

.header-controls span:hover {
  text-decoration: underline;
}

.header-right {
  font-size: 12px;
  text-align: right;
  color: var(--muted);
  max-width: 90%;
  justify-self: end;
}

/* WVDE forced white */
.wvde-link,
.wvde-link:visited,
.wvde-link:hover,
.wvde-link:active {
  color: #ffffff;
  text-decoration: none;
}

/* DASHBOARD */
.dashboard {
  flex: 1;
  display: grid;
  grid-template-columns: 7fr 8fr 5fr;
  grid-template-rows: 1fr 1fr;
  gap: var(--gap);
  padding: var(--gap);
}

.column-left {
  grid-row: 1 / span 2;
  display: grid;
  grid-template-rows: repeat(3, 1fr);
  gap: var(--gap);
}

/* PANELS */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  min-width: 0;
  height: 100%;
}

.panel-header {
  padding: 6px 10px;
  font-size: 12px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.panel-title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.panel-actions {
  flex: 0 0 auto;
  white-space: nowrap;
}

.panel-actions span {
  display: none;
  cursor: pointer;
  margin-left: 8px;
  user-select: none;
}

body.interactive .panel:hover .panel-actions span {
  display: inline;
}

.panel-body {
  flex-grow: 1;
  padding: 8px;
  overflow: hidden;
}

.panel-body iframe {
  width: 100%;
  height: 100%;
  min-height: 300px;
  border: none;
  display: block;
}

.note-editor {
  width: 100%;
  outline: none;
  white-space: pre-wrap;
}

/* FOOTER */
footer {
  height: var(--footer-height);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 12px;
}

footer a {
  color: var(--muted);
  text-decoration: none;
  padding: 0 6px;
}

/* MAXIMIZE MODE */
body.maximize .panel-header,
body.maximize footer {
  display: none;
}
</style>


</head>

<body class="interactive">

<header class="header-bar">
  <div>
    <div class="header-title" id="dashboardTitle"></div>
    <div class="header-meta">
      <span id="time12"></span> | <span id="time24"></span>
      • Refresh in <span id="refreshCountdown"></span>s
    </div>
    <div class="header-controls">
      <span id="interactiveBtn">Interactive Mode</span> •
      <span id="maximizeBtn">Maximize View</span> •
      <span id="resetBtn">Reset Dashboard</span>
    </div>
  </div>
  <div class="header-right" id="wvdeHeader"></div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>
  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer id="footer"></footer>

<script>
/* ---------------------------
   Persistence model (v2)
   localStorage["dashboardConfig"] = { panels: { [panelId]: { sourceKey, customUrl?, content? } } }
   Includes migration from older formats.
---------------------------- */

const STORAGE_KEY = "dashboardConfig";
let ADMIN = null;
let STORE = loadStore(); // { panels: {...} }

/* Load admin-config.json */
fetch("admin-config.json")
  .then(r => r.json())
  .then(cfg => {
    ADMIN = cfg;
    applyBranding();
    renderAllPanels();
    startClock();
    loadWVDE();
  })
  .catch(() => alert("Admin configuration failed to load."));

/* ---------- Store helpers ---------- */

function loadStore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return { panels: {} };

  try{
    const parsed = JSON.parse(raw);

    // If already v2 shape
    if (parsed && typeof parsed === "object" && parsed.panels && typeof parsed.panels === "object") {
      return parsed;
    }

    // Migration path: legacy "flat" object (e.g., { "left-1": {...}, "left-2": {...} })
    // We'll interpret values and convert to v2.
    const migrated = { panels: {} };
    if (parsed && typeof parsed === "object") {
      for (const [panelId, val] of Object.entries(parsed)) {
        if (!panelId.includes("-")) continue;

        // val might be {} or {content:""} or {customUrl:""} or something else
        migrated.panels[panelId] = migrated.panels[panelId] || {};

        if (val && typeof val === "object") {
          if (typeof val.content === "string") migrated.panels[panelId].content = val.content;
          if (typeof val.customUrl === "string") migrated.panels[panelId].customUrl = val.customUrl;

          // Some older versions didn’t store sourceKey; leave it undefined to fall back to ADMIN default
          if (typeof val.sourceKey === "string") migrated.panels[panelId].sourceKey = val.sourceKey;
        }
      }
    }

    // Save migrated format back
    localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
    return migrated;

  } catch(e){
    // If corrupted, start clean
    return { panels: {} };
  }
}

function saveStore(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE));
}

function getPanelUserState(panelId){
  STORE.panels[panelId] = STORE.panels[panelId] || {};
  return STORE.panels[panelId];
}

function setPanelUserState(panelId, partial){
  STORE.panels[panelId] = { ...(STORE.panels[panelId] || {}), ...partial };
  saveStore();
}

function clearAllUserState(){
  localStorage.removeItem(STORAGE_KEY);
  STORE = { panels: {} };
}

/* ---------- Branding ---------- */

function applyBranding(){
  dashboardTitle.textContent = ADMIN.branding.title;
  Object.entries(ADMIN.branding.colors).forEach(([k,v])=>{
    document.documentElement.style.setProperty(`--${k}`, v);
  });

  footer.innerHTML = ADMIN.footer.links
    .map(l => `<a href="${l.url}" target="_blank" rel="noopener noreferrer">${l.label}</a>`)
    .join(" | ");
}

/* ---------- Panel resolution ---------- */

function getEffectiveSourceKey(panelId){
  const userState = getPanelUserState(panelId);
  const userKey = userState.sourceKey;

  // Prefer user-selected sourceKey if it exists AND is valid
  if (userKey && ADMIN.sources[userKey]) return userKey;

  // Otherwise fall back to admin defaultAssignments
  const defKey = ADMIN.panels.defaultAssignments[panelId];
  if (defKey && ADMIN.sources[defKey]) return defKey;

  // If missing, return null
  return null;
}

function getEffectiveIframeUrl(panelId, srcKey){
  const src = ADMIN.sources[srcKey];
  const userState = getPanelUserState(panelId);

  // If user has customUrl AND this source allows editing, use it
  if (src?.type === "iframe" && src.allowEditUrl && userState.customUrl) {
    return userState.customUrl.trim();
  }

  return src?.src || "";
}

/* ---------- Render ---------- */

function renderAllPanels(){
  document.querySelectorAll(".panel").forEach(panel => renderPanel(panel.dataset.id));
}

function renderPanel(panelId){
  const container = document.querySelector(`.panel[data-id="${panelId}"]`);
  if (!container) return;

  const srcKey = getEffectiveSourceKey(panelId);
  const src = srcKey ? ADMIN.sources[srcKey] : null;

  const title = src?.title || "Empty Panel";

  const showOpen = (src?.type === "iframe");
  const showRefresh = (src?.type === "iframe");

  container.innerHTML = `
    <div class="panel-header">
      <div class="panel-title">${escapeHtml(title)}</div>
      <div class="panel-actions">
        ${showRefresh ? `<span title="Refresh panel" onclick="refreshPanel('${panelId}')">⟳</span>` : ""}
        ${showOpen ? `<span title="Open in new tab" onclick="openPanel('${panelId}')">↗</span>` : ""}
        <span title="Edit panel" onclick="editPanel('${panelId}')">✏</span>
      </div>
    </div>
    <div class="panel-body">
      ${renderPanelBody(panelId, srcKey, src)}
    </div>
  `;
}

function renderPanelBody(panelId, srcKey, src){
  if (!srcKey || !src) {
    return `Click ✏ to add content.`;
  }

  if (src.type === "notes") {
    const userState = getPanelUserState(panelId);
    const text = userState.content || "";
    return `
      <div class="note-editor" contenteditable="true"
           onblur="saveNote('${panelId}', this.innerText)">
        ${escapeHtml(text)}
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:11px;">
        Notes are saved to this browser (local storage) only and are not shared remotely.
      </div>
    `;
  }

  // iframe
  const url = getEffectiveIframeUrl(panelId, srcKey);
  if (!url) return `No URL configured. Click ✏ to update.`;
  return `<iframe src="${escapeAttr(url)}" loading="lazy"></iframe>`;
}

/* ---------- Edit UI ---------- */

function editPanel(panelId){
  const container = document.querySelector(`.panel[data-id="${panelId}"]`);
  if (!container) return;

  const currentKey = getEffectiveSourceKey(panelId);
  const userState = getPanelUserState(panelId);

  const currentSrc = currentKey ? ADMIN.sources[currentKey] : null;
  const showUrl = currentSrc?.allowEditUrl === true;
  const existingUrl = (userState.customUrl || "").trim();

  container.innerHTML = `
    <div class="panel-header">
      <div class="panel-title">Edit Panel</div>
      <div class="panel-actions">
        <span title="Cancel" onclick="renderPanel('${panelId}')">✖</span>
      </div>
    </div>
    <div class="panel-body">
      <label style="color:var(--muted);font-size:12px;">Source</label><br>
      <select id="srcSel-${panelId}" onchange="toggleUrlField('${panelId}')"
              style="width:100%;margin-top:6px;">
        ${Object.entries(ADMIN.sources).map(([k,v])=>{
          return `<option value="${escapeAttr(k)}" ${k===currentKey ? "selected" : ""}>${escapeHtml(v.title)}</option>`;
        }).join("")}
      </select>

      <div id="urlWrap-${panelId}" style="margin-top:10px;display:${showUrl ? "block" : "none"};">
        <label style="color:var(--muted);font-size:12px;">Custom URL</label><br>
        <input id="customUrlInput-${panelId}" type="text" value="${escapeAttr(existingUrl)}"
               placeholder="https://example.com"
               style="width:100%;margin-top:6px;">
        <div style="margin-top:6px;color:var(--muted);font-size:11px;">
          Tip: Some sites block embedding (X-Frame-Options / CSP). If blank, try ↗ open in a new tab.
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;">
        <button onclick="applyEdit('${panelId}')">Apply</button>
        <button onclick="resetPanelToDefault('${panelId}')">Reset Panel</button>
        <button onclick="renderPanel('${panelId}')">Cancel</button>
      </div>
    </div>
  `;
}

function toggleUrlField(panelId){
  const sel = document.getElementById(`srcSel-${panelId}`);
  if (!sel) return;
  const key = sel.value;
  const src = ADMIN.sources[key];
  const wrap = document.getElementById(`urlWrap-${panelId}`);
  if (!wrap) return;
  wrap.style.display = src?.allowEditUrl ? "block" : "none";
}

function applyEdit(panelId){
  const sel = document.getElementById(`srcSel-${panelId}`);
  if (!sel) return;

  const newKey = sel.value;
  if (!ADMIN.sources[newKey]) {
    alert("Invalid source selected.");
    return;
  }

  const src = ADMIN.sources[newKey];
  const update = { sourceKey: newKey };

  // Preserve notes content unless switching away from notes (we’ll keep it stored; harmless)
  // For URL editing:
  if (src.allowEditUrl) {
    const input = document.getElementById(`customUrlInput-${panelId}`);
    update.customUrl = (input?.value || "").trim();
  } else {
    // If switching to non-editable URL source, clear customUrl to avoid confusion
    update.customUrl = "";
  }

  setPanelUserState(panelId, update);
  renderPanel(panelId);
}

function resetPanelToDefault(panelId){
  // Clear ONLY this panel’s overrides
  delete STORE.panels[panelId];
  saveStore();
  renderPanel(panelId);
}

/* ---------- Notes ---------- */

function saveNote(panelId, text){
  // Save note content but do not force sourceKey; user chooses notes source explicitly.
  setPanelUserState(panelId, { content: text || "" });
}

/* ---------- Panel actions ---------- */

function openPanel(panelId){
  const srcKey = getEffectiveSourceKey(panelId);
  if (!srcKey) return;
  const src = ADMIN.sources[srcKey];
  if (!src || src.type !== "iframe") return;
  const url = getEffectiveIframeUrl(panelId, srcKey) || src.src;
  if (url) window.open(url, "_blank", "noopener,noreferrer");
}

function refreshPanel(panelId){
  const container = document.querySelector(`.panel[data-id="${panelId}"]`);
  if (!container) return;

  const iframe = container.querySelector("iframe");
  if (!iframe) return;

  const srcKey = getEffectiveSourceKey(panelId);
  if (!srcKey) return;

  const baseUrl = getEffectiveIframeUrl(panelId, srcKey);
  if (!baseUrl) return;

  iframe.src = addCacheBuster(baseUrl);
}

/* Add/replace a cache-buster param safely */
function addCacheBuster(url){
  try{
    const u = new URL(url, window.location.href);
    u.searchParams.set("_ts", Date.now().toString());
    return u.toString();
  }catch(e){
    // Fallback for odd URLs like some .m3u8 or non-standard strings
    const join = url.includes("?") ? "&" : "?";
    // Strip existing _ts if present (simple)
    const stripped = url.replace(/([?&])_ts=\d+/g, "$1").replace(/[?&]$/, "");
    return stripped + join + "_ts=" + Date.now();
  }
}

/* ---------- Clock + global refresh ---------- */

function startClock(){
  let remaining = ADMIN.defaults.refreshIntervalSeconds;

  setInterval(()=>{
    const d = new Date();
    time12.textContent = d.toLocaleTimeString("en-US");
    time24.textContent = d.toLocaleTimeString("en-GB");
    refreshCountdown.textContent = remaining--;

    if (remaining < 0) location.reload();
  }, 1000);
}

/* ---------- Reset dashboard ---------- */

resetBtn.onclick = () => {
  const msg =
    "Reset Dashboard?\n\n" +
    "This will reset all panels to the institutional default layout.\n\n" +
    "Any notes or custom URLs saved in this browser will be permanently deleted.\n\n" +
    "This action cannot be undone.";

  if (!confirm(msg)) return;

  clearAllUserState();
  document.body.className = "interactive";
  renderAllPanels();
};

interactiveBtn.onclick = () => document.body.className = "interactive";

maximizeBtn.onclick = () => {
  document.body.className = "maximize";
  document.documentElement.requestFullscreen().catch(()=>{});
};

/* ---------- WVDE ---------- */

function loadWVDE(){
  if (!ADMIN?.header?.showWVDE) return;

  fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
    .then(r => r.text())
    .then(xml => {
      const doc = new DOMParser().parseFromString(xml, "text/xml");

      const items = [...doc.querySelectorAll("item")]
        .filter(item =>
          ADMIN.header.wvde.counties.some(county =>
            item.querySelector("title")?.textContent.includes(county)
          )
        )
        .slice(0, ADMIN.header.wvde.maxLines)
        .map(item => {
          const title = item.querySelector("title")?.textContent || "";
          const desc  = item.querySelector("description")?.textContent || "";

          const countyName = title.replace("All schools in ", "").trim();

          let status = "Update";
          if (/closed/i.test(desc)) status = "Closed";
          else if (/delay/i.test(desc)) status = "Delayed";
          else if (/non-traditional/i.test(desc)) status = "Non-Traditional Learning";

          const dateMatch = desc.match(
            /(Mon\.|Tue\.|Wed\.|Thu\.|Fri\.|Sat\.|Sun\.)\s+[A-Za-z]{3}\.\s+\d{1,2},\s+\d{4}/
          );

          const dateText = dateMatch ? dateMatch[0] : "Date not specified";

          return `<strong>${escapeHtml(countyName)}</strong> — ${escapeHtml(status)} on ${escapeHtml(dateText)}`;
        });

      wvdeHeader.innerHTML = items.length
        ? `<a class="wvde-link" href="${escapeAttr(ADMIN.header.wvde.link)}" target="_blank" rel="noopener noreferrer">
             ${items.join("<br>")}
           </a>`
        : "No county closures or delays reported.";
    })
    .catch((err) => {
      console.error("WVDE fetch failed:", err);
      wvdeHeader.textContent = "WVDE data unavailable.";
    });
}

/* ---------- Utils ---------- */

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}

function escapeAttr(str){
  // attribute-safe version; reuse HTML escaping
  return escapeHtml(str);
}
</script>

</body>
</html>
