<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg: transparent;
  --panel: transparent;
  --border: transparent;
  --text: #ffffff;
  --muted: rgba(255,255,255,0.7);
  --accent: #93c5fd;
  --gap: 8px;
  --footer-height: 36px;
}

html, body{
  height:100%;
  margin:0;
  overflow:hidden;
}

*{ box-sizing:border-box; }

body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header-bar{
  display:grid;
  grid-template-columns:1fr 1fr;
  padding:10px 16px;
  border-bottom:1px solid var(--border);
}

.header-left{
  display:flex;
  flex-direction:column;
}

.header-title{
  font-size:18px;
  font-weight:700;
}

.header-meta{
  font-size:12px;
  color:var(--muted);
}

.header-controls{
  font-size:12px;
  color:var(--accent);
}

.header-controls span{
  cursor:pointer;
}

.header-controls span:hover{
  text-decoration:underline;
}

.header-right{
  font-size:12px;
  text-align:right;
  color:var(--muted);
}

/* DASHBOARD GRID */
.dashboard{
  flex:1;
  display:grid;
  grid-template-columns:7fr 8fr 5fr;
  grid-template-rows:1fr 1fr;
  gap:var(--gap);
  padding:var(--gap);
}

.column-left{
  grid-row:1 / span 2;
  display:grid;
  grid-template-rows:repeat(3,1fr);
  gap:var(--gap);
}

/* PANELS */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  flex-direction:column;
}

.panel-header{
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}

.panel-actions span{
  display:none;
  cursor:pointer;
}

body.interactive .panel:hover .panel-actions span{
  display:inline;
}

.panel-body{
  flex:1;
  padding:8px;
  overflow:auto;
}

.panel-body iframe{
  width:100%;
  height:100%;
  border:none;
}

.note-text{
  white-space:pre-wrap;
}

/* FOOTER */
footer{
  height:var(--footer-height);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:12px;
}

footer a{
  color:var(--muted);
  text-decoration:none;
  padding:0 6px;
}

/* MAXIMIZE */
body.maximize .panel-header,
body.maximize footer{
  display:none;
}
</style>
</head>

<body class="interactive">

<header class="header-bar">
  <div class="header-left">
    <div class="header-title" id="dashboardTitle"></div>
    <div class="header-meta">
      <span id="time12"></span> | <span id="time24"></span>
      • Refresh in <span id="refreshCountdown"></span>s
    </div>
    <div class="header-controls">
      <span id="interactiveBtn">Interactive Mode</span> •
      <span id="maximizeBtn">Maximize View</span> •
      <span id="resetBtn">Reset Dashboard</span>
    </div>
  </div>
  <div class="header-right" id="wvdeHeader"></div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>
  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer id="footer"></footer>

<script>
let ADMIN, CONFIG = {}, USER = JSON.parse(localStorage.getItem("dashboardConfig")) || {};

fetch("admin-config.json")
  .then(r => r.json())
  .then(cfg => {
    ADMIN = cfg;
    applyBranding();
    init();
  });

function applyBranding(){
  dashboardTitle.textContent = ADMIN.branding.title;

  const map = {
    background: "--bg",
    panel: "--panel",
    border: "--border",
    text: "--text",
    muted: "--muted",
    accent: "--accent"
  };

  Object.entries(ADMIN.branding.colors).forEach(([k,v])=>{
    document.documentElement.style.setProperty(map[k], v);
  });

  footer.innerHTML = ADMIN.footer.links
    .map(l => `<a href="${l.url}" target="_blank">${l.label}</a>`)
    .join(" | ");
}

function init(){
  CONFIG = { ...ADMIN.panels.defaultAssignments, ...USER };
  render();
  startClock();
  loadWVDE();
}

function render(){
  document.querySelectorAll(".panel").forEach(p=>{
    const id = p.dataset.id;
    const srcKey = CONFIG[id];
    const src = ADMIN.sources[srcKey];

    p.innerHTML = `
      <div class="panel-header">
        ${src?.title || "Empty Panel"}
        <span class="panel-actions">
          ${src?.type==="iframe" ? `<span onclick="openPanel('${id}')">↗</span>` : ""}
          <span onclick="editPanel('${id}')">✏</span>
        </span>
      </div>
      <div class="panel-body">
        ${!src ? "Click ✏ to add content" :
          src.type==="notes"
            ? `<div class="note-text">${USER[id]?.content || ""}</div>`
            : `<iframe src="${src.src}"></iframe>`}
      </div>`;
  });
}

function editPanel(id){
  const current = CONFIG[id];
  document.querySelector(`[data-id="${id}"]`).innerHTML = `
    <div class="panel-header">Edit Panel</div>
    <div class="panel-body">
      <select id="srcSel">
        ${Object.entries(ADMIN.sources).map(([k,v]) =>
          `<option value="${k}" ${k===current?"selected":""}>${v.title}</option>`
        ).join("")}
      </select><br><br>
      <button onclick="applyEdit('${id}')">Apply</button>
      <button onclick="render()">Cancel</button>
    </div>`;
}

function applyEdit(id){
  const val = document.getElementById("srcSel").value;
  CONFIG[id] = val;
  USER[id] = {};
  localStorage.setItem("dashboardConfig", JSON.stringify(USER));
  render();
}

function openPanel(id){
  const s = ADMIN.sources[CONFIG[id]];
  if(s?.src) window.open(s.src,"_blank");
}

function startClock(){
  let remaining = ADMIN.defaults.refreshIntervalSeconds;
  setInterval(()=>{
    const d=new Date();
    time12.textContent=d.toLocaleTimeString("en-US");
    time24.textContent=d.toLocaleTimeString("en-GB");
    refreshCountdown.textContent=remaining--;
    if(remaining<0) location.reload();
  },1000);
}

resetBtn.onclick=()=>{
  if(confirm("Reset dashboard and delete all notes?")){
    localStorage.removeItem("dashboardConfig");
    USER={};
    CONFIG={...ADMIN.panels.defaultAssignments};
    document.body.className="interactive";
    render();
  }
};

interactiveBtn.onclick=()=>document.body.className="interactive";
maximizeBtn.onclick=()=>{
  document.body.className="maximize";
  document.documentElement.requestFullscreen().catch(()=>{});
};

function loadWVDE(){
  fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
    .then(r=>r.text())
    .then(t=>{
      const doc=new DOMParser().parseFromString(t,"text/xml");
      const items=[...doc.querySelectorAll("item")]
        .filter(i=>ADMIN.header.wvde.counties.some(c=>i.textContent.includes(c)))
        .slice(0,ADMIN.header.wvde.maxLines)
        .map(i=>i.querySelector("title").textContent);
      wvdeHeader.innerHTML = items.length
        ? `<a href="${ADMIN.header.wvde.link}" target="_blank">${items.join("<br>")}</a>`
        : "No county closures reported.";
    });
}
</script>

</body>
</html>
