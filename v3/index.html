<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather & Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg: transparent;
  --panel: transparent;
  --border: transparent;
  --text: #ffffff;
  --muted: #e6e6e6;
  --accent: #860038;
  --gap: 8px;
  --footer-height: 36px;
}

html, body{
  height:100%;
  margin:0;
  overflow:hidden;
}

*{ box-sizing:border-box; }

body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header-bar{
  display:grid;
  grid-template-columns:1fr 1fr;
  padding:10px 16px;
  border-bottom:1px solid var(--border);
}

.header-left{
  display:flex;
  flex-direction:column;
}

.header-title{
  font-size:18px;
  font-weight:700;
}

.header-meta{
  font-size:12px;
  color:var(--muted);
}

.header-controls{
  font-size:12px;
  color:var(--accent);
}

.header-controls span{
  cursor:pointer;
}

.header-controls span:hover{
  text-decoration:underline;
}

.header-right{
  font-size:12px;
  text-align:right;
  color:var(--muted);
  max-width:90%;
  justify-self:end;
}

/* WVDE link forced white */
.wvde-link,
.wvde-link:visited,
.wvde-link:hover,
.wvde-link:active{
  color:#ffffff;
  text-decoration:none;
}

/* DASHBOARD */
.dashboard{
  flex:1;
  display:grid;
  grid-template-columns:7fr 8fr 5fr;
  grid-template-rows:1fr 1fr;
  gap:var(--gap);
  padding:var(--gap);
}

.column-left{
  grid-row:1 / span 2;
  display:grid;
  grid-template-rows:repeat(3,1fr);
  gap:var(--gap);
}

/* PANELS */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  flex-direction:column;
}

.panel-header{
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}

.panel-actions span{
  display:none;
  cursor:pointer;
  margin-left:6px;
}

body.interactive .panel:hover .panel-actions span{
  display:inline;
}

.panel-body{
  flex:1;
  padding:8px;
  overflow:auto;
}

.panel-body iframe{
  width:100%;
  height:100%;
  border:none;
}

/* FOOTER */
footer{
  height:var(--footer-height);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:12px;
}

footer a{
  color:var(--muted);
  text-decoration:none;
  padding:0 6px;
}

body.maximize .panel-header,
body.maximize footer{
  display:none;
}
</style>
</head>

<body class="interactive">

<header class="header-bar">
  <div class="header-left">
    <div class="header-title" id="dashboardTitle"></div>
    <div class="header-meta">
      <span id="time12"></span> | <span id="time24"></span>
      • Refresh in <span id="refreshCountdown"></span>s
    </div>
    <div class="header-controls">
      <span id="interactiveBtn">Interactive Mode</span> •
      <span id="maximizeBtn">Maximize View</span> •
      <span id="resetBtn">Reset Dashboard</span>
    </div>
  </div>
  <div class="header-right" id="wvdeHeader"></div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>
  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer id="footer"></footer>

<script>
let ADMIN, CONFIG = {}, USER = JSON.parse(localStorage.getItem("dashboardConfig")) || {};

/* LOAD ADMIN CONFIG */
fetch("admin-config.json")
  .then(r => r.json())
  .then(cfg => {
    ADMIN = cfg;
    applyBranding();
    init();
  })
  .catch(() => alert("Admin configuration failed to load."));

function applyBranding(){
  dashboardTitle.textContent = ADMIN.branding.title;

  const map = {
    background: "--bg",
    panel: "--panel",
    border: "--border",
    text: "--text",
    muted: "--muted",
    accent: "--accent"
  };

  Object.entries(ADMIN.branding.colors).forEach(([k,v])=>{
    document.documentElement.style.setProperty(map[k], v);
  });

  footer.innerHTML = ADMIN.footer.links
    .map(l => `<a href="${l.url}" target="_blank">${l.label}</a>`)
    .join(" | ");
}

function init(){
  CONFIG = { ...ADMIN.panels.defaultAssignments, ...USER };
  render();
  startClock();
  loadWVDE();
}

function render(){
  document.querySelectorAll(".panel").forEach(p=>{
    const id = p.dataset.id;
    const srcKey = CONFIG[id];
    const src = ADMIN.sources[srcKey];

    p.innerHTML = `
      <div class="panel-header">
        ${src?.title || "Empty Panel"}
        <span class="panel-actions">
          ${src?.type==="iframe" ? `<span onclick="openPanel('${id}')">↗</span>` : ""}
          <span onclick="editPanel('${id}')">✏</span>
        </span>
      </div>
      <div class="panel-body">
        ${!src ? "Click ✏ to add content" :
          src.type==="notes"
            ? `<div contenteditable="true"
                     onblur="saveNote('${id}',this.innerText)">
                ${USER[id]?.content || ""}
               </div>`
            : `<iframe src="${src.src}" loading="lazy"></iframe>`}
      </div>`;
  });
}

function editPanel(id){
  const current = CONFIG[id];
  document.querySelector(`[data-id="${id}"]`).innerHTML = `
    <div class="panel-header">Edit Panel</div>
    <div class="panel-body">
      <select id="srcSel">
        ${Object.entries(ADMIN.sources).map(([k,v]) =>
          `<option value="${k}" ${k===current?"selected":""}>${v.title}</option>`
        ).join("")}
      </select><br><br>
      <button onclick="applyEdit('${id}')">Apply</button>
      <button onclick="render()">Cancel</button>
    </div>`;
}

function applyEdit(id){
  const val = document.getElementById("srcSel").value;
  CONFIG[id] = val;
  USER[id] = {};
  localStorage.setItem("dashboardConfig", JSON.stringify(USER));
  render();
}

function saveNote(id,text){
  USER[id]={content:text};
  localStorage.setItem("dashboardConfig", JSON.stringify(USER));
}

function openPanel(id){
  const s = ADMIN.sources[CONFIG[id]];
  if(s?.src) window.open(s.src,"_blank");
}

function startClock(){
  let remaining = ADMIN.defaults.refreshIntervalSeconds;
  setInterval(()=>{
    const d=new Date();
    time12.textContent=d.toLocaleTimeString("en-US");
    time24.textContent=d.toLocaleTimeString("en-GB");
    refreshCountdown.textContent=remaining--;
    if(remaining<0) location.reload();
  },1000);
}

resetBtn.onclick = () => {
  const msg =
    "Reset Dashboard?\n\n" +
    "This will reset all dashboard panels to the institutional default layout.\n\n" +
    "Any notes or text you have added will be permanently deleted.\n\n" +
    "This action cannot be undone.";

  if (!confirm(msg)) return;

  localStorage.removeItem("dashboardConfig");
  USER = {};
  CONFIG = JSON.parse(JSON.stringify(ADMIN.panels.defaultAssignments));

  document.body.classList.remove("maximize");
  document.body.classList.add("interactive");

  render();
};

interactiveBtn.onclick=()=>document.body.className="interactive";
maximizeBtn.onclick=()=>{
  document.body.className="maximize";
  document.documentElement.requestFullscreen().catch(()=>{});
};

/* WVDE */
function loadWVDE(){
  fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
    .then(r=>r.text())
    .then(xml=>{
      const doc=new DOMParser().parseFromString(xml,"text/xml");
      const items=[...doc.querySelectorAll("item")]
        .filter(i=>ADMIN.header.wvde.counties.some(c=>i.textContent.includes(c)))
        .slice(0,ADMIN.header.wvde.maxLines)
        .map(i=>{
          const title=i.querySelector("title").textContent.replace("All schools in ","");
          const desc=i.querySelector("description").textContent;

          let status="Update";
          if(/closed/i.test(desc))status="Closed";
          else if(/delay/i.test(desc))status="Delayed";
          else if(/non-traditional/i.test(desc))status="Non-Traditional Learning";

          const date=desc.match(
            /(Mon\.|Tue\.|Wed\.|Thu\.|Fri\.|Sat\.|Sun\.)\s+[A-Za-z]{3}\.\s+\d{1,2},\s+\d{4}/
          );

          return `<strong>${title}</strong> — ${status} on ${date ? date[0] : "Date not specified"}`;
        });

      wvdeHeader.innerHTML = items.length
        ? `<a href="${ADMIN.header.wvde.link}" target="_blank" class="wvde-link">
            ${items.join("<br>")}
           </a>`
        : "No county closures or delays reported.";
    })
    .catch(()=>wvdeHeader.textContent="WVDE data unavailable.");
}
</script>

</body>
</html>
