<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather & Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b1220;
  --panel:#020617;
  --border:#1e293b;
  --text:#fff;
  --muted:rgba(255,255,255,.7);
  --accent:#93c5fd;
  --gap:8px;

  --col1:7fr;
  --col2:8fr;
  --col3:5fr;
  --footer-height:36px;
}

html, body{
  height:100%;
  margin:0;
  overflow:hidden;
}

*{ box-sizing:border-box; }

body{
  background:var(--bg);
  color:var(--text);
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* HEADER */
.header-bar{
  display:grid;
  grid-template-columns:1fr 1fr;
  padding:10px 16px;
  background:#020617f2;
  border-bottom:1px solid var(--border);
}

.header-left{display:flex;flex-direction:column}
.header-title{font-size:18px;font-weight:700}
.header-meta{font-size:12px;color:var(--muted);margin-top:4px}
.header-controls{font-size:12px;margin-top:4px;color:var(--accent)}
.header-controls span{cursor:pointer}
.header-controls span:hover{text-decoration:underline}
.separator{margin:0 6px}

.header-right{
  font-size:12px;
  color:var(--muted);
  text-align:right;
}

/* DASHBOARD */
.dashboard{
  flex:1;
  min-height:0;
  display:grid;
  grid-template-columns:var(--col1) var(--col2) var(--col3);
  grid-template-rows:1fr 1fr;
  gap:var(--gap);
  padding:var(--gap);
}

.column-left{
  grid-column:1;
  grid-row:1/span 2;
  display:grid;
  grid-template-rows:repeat(3,1fr);
  gap:var(--gap);
  min-height:0;
}

/* PANELS */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  flex-direction:column;
  min-height:0;
}

.panel-header{
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}

.panel-actions span{
  display:none;
  cursor:pointer;
  opacity:.7;
}

body.interactive .panel:hover .panel-actions span{
  display:inline;
}

.panel-body{
  flex:1;
  min-height:0;
  padding:6px;
  overflow:auto;
}

.panel-body iframe{
  width:100%;
  height:100%;
  border:none;
}

/* FOOTER */
footer{
  height:var(--footer-height);
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020617f2;
  border-top:1px solid var(--border);
  font-size:12px;
}

footer a{color:var(--muted);text-decoration:none;padding:0 6px}

/* MAXIMIZE */
body.maximize .panel-header,
body.maximize footer{display:none}
</style>
</head>

<body class="interactive">

<header class="header-bar">
  <div class="header-left">
    <div class="header-title">Weather & Operations Dashboard</div>
    <div class="header-meta">
      <span id="time12"></span> | <span id="time24"></span> • Refresh in <span id="refreshCountdown"></span>s
    </div>
    <div class="header-controls">
      <span id="interactiveBtn">Interactive Mode</span> •
      <span id="maximizeBtn">Maximize View</span> •
      <span id="resetBtn">Reset Dashboard</span>
    </div>
  </div>
  <div class="header-right" id="wvdeHeader">Loading WVDE closures…</div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>
  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer>
  <a href="https://www.fairmontstate.edu" target="_blank">FSU</a> |
  <a href="https://www.wv511.org" target="_blank">WV 511</a> |
  <a href="https://www.weather.gov/rlx" target="_blank">NWS RLX</a>
</footer>

<script>
/* ===== DOM BINDINGS ===== */
const time12 = document.getElementById("time12");
const time24 = document.getElementById("time24");
const refreshCountdown = document.getElementById("refreshCountdown");
const wvdeHeader = document.getElementById("wvdeHeader");

document.getElementById("interactiveBtn").onclick = setInteractive;
document.getElementById("maximizeBtn").onclick = setMaximize;
document.getElementById("resetBtn").onclick = resetDashboard;

/* ===== CLOCK ===== */
const REFRESH_INTERVAL = 600;
let remaining = REFRESH_INTERVAL;

function tick(){
  const d = new Date();
  time12.textContent = d.toLocaleTimeString("en-US");
  time24.textContent = d.toLocaleTimeString("en-GB");
  refreshCountdown.textContent = remaining;
  if(--remaining < 0) location.reload();
}
tick();
setInterval(tick,1000);

/* ===== PRESETS ===== */
const PRESETS={
  traffic:{type:"iframe",title:"Traffic Camera",src:"https://webcam.io/webcams/MpbQgP?embed=true"},
  ventusky:{type:"iframe",title:"Radar (Ventusky)",src:"https://embed.ventusky.com/?p=38.98;-81.21;7&l=radar"},
  nws:{type:"iframe",title:"NWS RLX",src:"https://www.weather.gov/rlx"},
  radio:{type:"iframe",title:"Emergency Radio",src:"https://www.broadcastify.com/webPlayer/40500"}
};

const DEFAULTS={
  "left-1":PRESETS.traffic,
  "center-top":PRESETS.ventusky,
  "right-top":PRESETS.nws
};

let config = JSON.parse(localStorage.getItem("dashboardConfig")) || structuredClone(DEFAULTS);

/* ===== RENDER ===== */
function render(){
  document.querySelectorAll(".panel").forEach(p=>{
    const id=p.dataset.id;
    const c=config[id];
    if(!c) return;

    p.innerHTML=`
      <div class="panel-header">
        <span>${c.title}</span>
        <span class="panel-actions">
          <span onclick="openPanel('${id}')">↗</span>
        </span>
      </div>
      <div class="panel-body">
        <iframe src="${c.src}" loading="lazy"></iframe>
      </div>`;
  });
}
render();

/* ===== PANEL ACTIONS ===== */
function openPanel(id){
  window.open(config[id].src,"_blank");
}

/* ===== MODES ===== */
function setInteractive(){
  document.body.className="interactive";
}

function setMaximize(){
  document.body.className="maximize";
  document.documentElement.requestFullscreen().catch(()=>{});
}

document.addEventListener("fullscreenchange",()=>{
  if(!document.fullscreenElement) setInteractive();
});

/* ===== RESET ===== */
function resetDashboard(){
  if(confirm("Reset dashboard layout and settings?")){
    localStorage.clear();
    location.reload();
  }
}

/* ===== WVDE ===== */
fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
.then(r=>r.text())
.then(xml=>{
  const doc=new DOMParser().parseFromString(xml,"text/xml");
  const items=[...doc.querySelectorAll("item")];
  const counties=["Marion","Harrison","Monongalia"];
  const rows=items.filter(i=>counties.some(c=>i.textContent.includes(c)))
    .map(i=>i.querySelector("title").textContent);
  wvdeHeader.textContent = rows.length ? rows.join(" | ") : "No county closures reported.";
})
.catch(()=>wvdeHeader.textContent="WVDE data unavailable.");
</script>

</body>
</html>
