<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather & Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b1220; --panel:#020617; --border:#1e293b;
  --text:#fff; --muted:rgba(255,255,255,.7);
  --gap:8px; --col1:35%; --col2:40%; --col3:25%;
  --header-height:64px; --footer-height:36px;
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; background:var(--bg);
  color:var(--text); font-family:Arial,sans-serif;
  display:flex; flex-direction:column;
}

/* ===== HEADER ===== */
.header-bar{
  min-height:var(--header-height);
  display:grid;
  grid-template-columns:1fr 1fr;
  padding:10px 16px;
  background:#020617f2;
  border-bottom:1px solid var(--border);
}
.header-left{display:flex;flex-direction:column}
.header-title{font-size:18px;font-weight:700}
.header-meta{font-size:12px;color:var(--muted);margin-top:4px}
.separator{margin:0 6px}

.header-right{
  font-size:12px;
  color:var(--muted);
  line-height:1.35;
  max-width:90%;
  justify-self:end;
  text-align:right;
}
.header-right a{color:var(--text);text-decoration:none}
.header-right a:hover{text-decoration:underline}

/* ===== DASHBOARD ===== */
.dashboard{
  flex:1;
  display:grid;
  grid-template-columns:var(--col1) var(--col2) var(--col3);
  grid-template-rows:1fr 1fr;
  gap:var(--gap);
  padding:var(--gap);
}
.column-left{
  grid-column:1;
  grid-row:1/span 2;
  display:grid;
  grid-template-rows:repeat(3,1fr);
  gap:var(--gap);
}

/* ===== PANELS ===== */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.panel-header{
  padding:6px 10px;
  font-size:12px;
  font-weight:bold;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.panel-actions{
  display:flex;
  gap:8px;
}
.panel-action{
  display:none;
  cursor:pointer;
  font-size:12px;
  opacity:.7;
}
.panel:hover .panel-action{display:inline}
.panel-action:hover{opacity:1}

.panel-body{flex:1;padding:6px}
.panel-body iframe{width:100%;height:100%;border:none}

/* ===== NOTES ===== */
.notes-display{
  font-size:13px;
  white-space:pre-wrap;
  color:#e5e7eb;
}
.notes-edit{
  width:100%;
  height:100%;
  background:#020617;
  color:#fff;
  border:1px solid var(--border);
  border-radius:4px;
  padding:6px;
  resize:none;
}

/* ===== EDIT UI ===== */
.edit-form{padding:10px;font-size:12px}
.edit-form label{display:block;margin-top:6px;color:var(--muted)}
.edit-form input, .edit-form select{
  width:100%;
  padding:6px;
  margin-top:2px;
  background:#020617;
  color:#fff;
  border:1px solid var(--border);
  border-radius:4px;
}
.edit-form small{
  display:block;
  margin-top:6px;
  color:var(--muted);
}
.actions{
  display:flex;
  gap:6px;
  margin-top:10px;
}
.actions button{
  flex:1;
  padding:6px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:12px;
}
.apply{background:#2563eb;color:#fff}
.reset{background:#7c2d12;color:#fff}
.cancel{background:#374151;color:#fff}

/* ===== FOOTER ===== */
footer{
  height:var(--footer-height);
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020617f2;
  border-top:1px solid var(--border);
  font-size:12px;
  color:var(--muted);
}
footer a{color:var(--muted);text-decoration:none;padding:0 6px}
footer span{opacity:.5}
</style>
</head>

<body>

<header class="header-bar">
  <div class="header-left">
    <div class="header-title">Weather & Operations Dashboard</div>
    <div class="header-meta">
      <span id="time12"></span>
      <span class="separator">|</span>
      <span id="time24"></span>
      <span class="separator">•</span>
      Refresh in <span id="refreshCountdown"></span>s
    </div>
  </div>
  <div class="header-right" id="wvdeHeader">Loading WVDE closures…</div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>
  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer>
  <a href="https://www.fairmontstate.edu" target="_blank">FSU</a><span>|</span>
  <a href="https://www.wv511.org" target="_blank">WV 511</a><span>|</span>
  <a href="https://www.weather.gov/rlx" target="_blank">NWS RLX</a>
</footer>

<script>
/* ===== CLOCK ===== */
const REFRESH_INTERVAL=600;
let remaining=REFRESH_INTERVAL;
function tick(){
  const n=new Date();
  time12.textContent=n.toLocaleTimeString("en-US");
  time24.textContent=n.toLocaleTimeString("en-GB");
  refreshCountdown.textContent=remaining;
  if(--remaining<0) location.reload();
}
tick(); setInterval(tick,1000);

/* ===== PANEL SOURCES ===== */
const PANEL_SOURCES={
  iframe:{label:"Custom iframe",type:"iframe"},
  notes:{label:"Notes / Text",type:"notes"}
};

const DEFAULTS={
  "left-1":{type:"iframe",title:"Traffic Camera",src:"https://webcam.io/webcams/MpbQgP?embed=true"},
  "center-top":{type:"iframe",title:"Radar (Ventusky)",src:"https://embed.ventusky.com/?p=38.98;-81.21;7&l=radar"},
  "right-top":{type:"iframe",title:"NWS RLX",src:"https://www.weather.gov/rlx"}
};

let config=JSON.parse(localStorage.getItem("dashboardConfig"))||structuredClone(DEFAULTS);
function save(){localStorage.setItem("dashboardConfig",JSON.stringify(config));}

/* ===== RENDER ===== */
function render(){
  document.querySelectorAll(".panel").forEach(p=>{
    const id=p.dataset.id;
    const c=config[id]||{};
    const isIframe=c.src;
    const actions=[];
    if(isIframe){
      actions.push(`<span class="panel-action" onclick="refreshPanel('${id}')">⟳</span>`);
      actions.push(`<span class="panel-action" onclick="openPanel('${id}')">↗</span>`);
    }
    actions.push(`<span class="panel-action" onclick="edit('${id}')">✏</span>`);

    let body="";
    if(c.type==="notes"){
      body=`<div class="notes-display">${c.text||""}</div>`;
    }else if(isIframe){
      body=`<iframe src="${c.src}" loading="lazy"></iframe>`;
    }

    p.innerHTML=`
      <div class="panel-header">
        <span>${c.title||""}</span>
        <span class="panel-actions">${actions.join("")}</span>
      </div>
      <div class="panel-body">${body}</div>`;
  });
}

function refreshPanel(id){
  const f=document.querySelector(`[data-id="${id}"] iframe`);
  if(f) f.src=f.src;
}
function openPanel(id){
  const c=config[id];
  if(c?.src) window.open(c.src,"_blank","noopener");
}

/* ===== EDIT ===== */
function edit(id){
  const c=config[id]||{type:"iframe"};
  document.querySelector(`[data-id="${id}"]`).innerHTML=`
    <div class="panel-header">Edit Panel</div>
    <div class="edit-form">
      <label>Source</label>
      <select id="type-${id}" onchange="toggleFields('${id}')">
        <option value="iframe" ${c.type==="iframe"?"selected":""}>iframe</option>
        <option value="notes" ${c.type==="notes"?"selected":""}>Notes / Text</option>
      </select>

      <label>Title</label>
      <input id="title-${id}" value="${c.title||""}">

      <div id="iframe-${id}">
        <label>iframe URL</label>
        <input id="src-${id}" value="${c.src||""}">
      </div>

      <div id="notes-${id}">
        <label>Notes</label>
        <textarea class="notes-edit" id="text-${id}">${c.text||""}</textarea>
        <small>Notes are stored locally in your browser and are not shared or synced.</small>
      </div>

      <div class="actions">
        <button class="apply" onclick="apply('${id}')">Apply</button>
        <button class="reset" onclick="resetPanel('${id}')">Reset</button>
        <button class="cancel" onclick="render()">Cancel</button>
      </div>
    </div>`;
  toggleFields(id);
}

function toggleFields(id){
  const type=document.getElementById(`type-${id}`).value;
  document.getElementById(`iframe-${id}`).style.display=type==="iframe"?"block":"none";
  document.getElementById(`notes-${id}`).style.display=type==="notes"?"block":"none";
}

function apply(id){
  const type=document.getElementById(`type-${id}`).value;
  config[id]={
    type,
    title:document.getElementById(`title-${id}`).value,
    src:type==="iframe"?document.getElementById(`src-${id}`).value:undefined,
    text:type==="notes"?document.getElementById(`text-${id}`).value:undefined
  };
  save(); render();
}
function resetPanel(id){
  if(DEFAULTS[id]) config[id]=structuredClone(DEFAULTS[id]);
  else delete config[id];
  save(); render();
}
render();

/* ===== WVDE RSS ===== */
fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
.then(r=>r.text())
.then(xml=>{
  const doc=new DOMParser().parseFromString(xml,"text/xml");
  const items=[...doc.querySelectorAll("item")];
  const counties=["Marion","Harrison","Monongalia"];
  const rows=items.filter(i=>counties.some(c=>i.querySelector("title").textContent.includes(c)))
    .map(i=>{
      const county=i.querySelector("title").textContent.replace("All schools in ","");
      const d=i.querySelector("description").textContent;
      let status="Update";
      if(d.includes("closed")) status="Closed";
      else if(d.includes("delay")) status="Delay";
      else if(d.includes("non-traditional")) status="NTI";
      const date=d.match(/on (.+?)\./)?.[1]||"";
      return `${county} — ${status}${date?` (${date})`:""}`;
    });

  wvdeHeader.innerHTML=rows.length
    ? `<a href="https://wveis.k12.wv.us/closings/" target="_blank">${rows.join("<br>")}</a>`
    : "No county closures or delays reported.";
})
.catch(()=>wvdeHeader.textContent="WVDE data unavailable.");
</script>

</body>
</html>
