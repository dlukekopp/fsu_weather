<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather & Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b1220;
  --panel:#020617;
  --border:#1e293b;
  --text:#ffffff;
  --muted:rgba(255,255,255,.7);
  --accent:#93c5fd;
  --gap:8px;

  --col1:35%;
  --col2:40%;
  --col3:25%;

  --footer-height:36px;
}

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
}

/* ================= HEADER ================= */

.header-bar{
  display:grid;
  grid-template-columns:1fr 1fr;
  padding:10px 16px;
  background:#020617f2;
  border-bottom:1px solid var(--border);
}

.header-left{
  display:flex;
  flex-direction:column;
}

.header-title{
  font-size:18px;
  font-weight:700;
}

.header-meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.header-controls{
  font-size:12px;
  margin-top:4px;
  color:var(--accent);
}

.header-controls span{
  cursor:pointer;
}

.header-controls span:hover{
  text-decoration:underline;
}

.separator{margin:0 6px}

.header-right{
  font-size:12px;
  color:var(--muted);
  line-height:1.35;
  max-width:90%;
  justify-self:end;
  text-align:right;
}

.header-right a{
  color:var(--text);
  text-decoration:none;
}

.header-right a:hover{
  text-decoration:underline;
}

/* ================= DASHBOARD ================= */

.dashboard{
  flex:1;
  display:grid;
  grid-template-columns:var(--col1) var(--col2) var(--col3);
  grid-template-rows:1fr 1fr;
  gap:var(--gap);
  padding:var(--gap);
}

.column-left{
  grid-column:1;
  grid-row:1 / span 2;
  display:grid;
  grid-template-rows:repeat(3,1fr);
  gap:var(--gap);
}

/* ================= PANELS ================= */

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.panel-header{
  padding:6px 10px;
  font-size:12px;
  font-weight:bold;
  color:var(--muted);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.panel-actions{
  display:flex;
  gap:8px;
}

.panel-action{
  display:none;
  cursor:pointer;
  font-size:12px;
  opacity:.7;
}

body.interactive .panel:hover .panel-action{
  display:inline;
}

.panel-action:hover{opacity:1}

.panel-body{
  flex:1;
  padding:6px;
}

.panel-body iframe{
  width:100%;
  height:100%;
  border:none;
}

/* ================= NOTES ================= */

.notes-display{
  font-size:13px;
  white-space:pre-wrap;
  color:#e5e7eb;
}

/* ================= FOOTER ================= */

footer{
  height:var(--footer-height);
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020617f2;
  border-top:1px solid var(--border);
  font-size:12px;
  color:var(--muted);
}

footer a{
  color:var(--muted);
  text-decoration:none;
  padding:0 6px;
}

footer span{opacity:.5}

/* ================= MAXIMIZE VIEW ================= */

body.maximize .panel-header{
  display:none;
}

body.maximize footer{
  display:none;
}
</style>
</head>

<body class="interactive">

<header class="header-bar">
  <div class="header-left">
    <div class="header-title">Weather & Operations Dashboard</div>
    <div class="header-meta">
      <span id="time12"></span>
      <span class="separator">|</span>
      <span id="time24"></span>
      <span class="separator">•</span>
      Refresh in <span id="refreshCountdown"></span>s
    </div>
    <div class="header-controls">
      <span onclick="setInteractiveMode()">Interactive Mode</span>
      <span class="separator">•</span>
      <span onclick="setMaximizeView()">Maximize View</span>
      <span class="separator">•</span>
      <span onclick="resetDashboard()">Reset Dashboard</span>
    </div>
  </div>

  <div class="header-right" id="wvdeHeader">
    Loading WVDE closures…
  </div>
</header>

<div class="dashboard">
  <div class="column-left">
    <div class="panel" data-id="left-1"></div>
    <div class="panel" data-id="left-2"></div>
    <div class="panel" data-id="left-3"></div>
  </div>

  <div class="panel" data-id="center-top"></div>
  <div class="panel" data-id="right-top"></div>
  <div class="panel" data-id="center-bottom"></div>
  <div class="panel" data-id="right-bottom"></div>
</div>

<footer>
  <a href="https://www.fairmontstate.edu" target="_blank">FSU</a><span>|</span>
  <a href="https://www.wv511.org" target="_blank">WV 511</a><span>|</span>
  <a href="https://www.weather.gov/rlx" target="_blank">NWS RLX</a>
</footer>

<script>
/* ================= CLOCK ================= */

const REFRESH_INTERVAL = 600;
let remaining = REFRESH_INTERVAL;

function tick(){
  const now = new Date();
  time12.textContent = now.toLocaleTimeString("en-US");
  time24.textContent = now.toLocaleTimeString("en-GB");
  refreshCountdown.textContent = remaining;
  if(--remaining < 0) location.reload();
}

tick();
setInterval(tick,1000);

/* ================= MODE MANAGEMENT ================= */

function setInteractiveMode(){
  document.body.classList.remove("maximize");
  document.body.classList.add("interactive");
  localStorage.setItem("dashboardMode","interactive");

  if(document.fullscreenElement){
    document.exitFullscreen();
  }
}

function setMaximizeView(){
  document.body.classList.remove("interactive");
  document.body.classList.add("maximize");
  localStorage.setItem("dashboardMode","maximize");

  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }
}

document.addEventListener("fullscreenchange",()=>{
  if(!document.fullscreenElement){
    setInteractiveMode();
  }
});

/* ================= RESET ================= */

function resetDashboard(){
  if(confirm("Reset dashboard layout and settings?")){
    localStorage.clear();
    location.reload();
  }
}

/* ================= LOAD MODE ================= */

const params = new URLSearchParams(window.location.search);
const savedMode = params.get("mode") || localStorage.getItem("dashboardMode") || "interactive";

if(savedMode === "maximize"){
  document.body.classList.add("maximize");
  document.body.classList.remove("interactive");
}

/* ================= WVDE RSS ================= */

fetch("https://api.allorigins.win/raw?url=https://wveis.k12.wv.us/closings/rss.php")
.then(r=>r.text())
.then(xml=>{
  const doc = new DOMParser().parseFromString(xml,"text/xml");
  const items = [...doc.querySelectorAll("item")];
  const counties = ["Marion","Harrison","Monongalia"];

  const rows = items
    .filter(i=>counties.some(c=>i.querySelector("title").textContent.includes(c)))
    .map(i=>{
      const county = i.querySelector("title").textContent.replace("All schools in ","");
      const desc = i.querySelector("description").textContent;
      let status = "Update";

      if(desc.includes("closed")) status="Closed";
      else if(desc.includes("delay")) status="Delay";
      else if(desc.includes("non-traditional")) status="NTI";

      const date = desc.match(/on (.+?)\./)?.[1] || "";
      return `${county} — ${status}${date ? ` (${date})` : ""}`;
    });

  wvdeHeader.innerHTML = rows.length
    ? `<a href="https://wveis.k12.wv.us/closings/" target="_blank">${rows.join("<br>")}</a>`
    : "No county closures or delays reported.";
})
.catch(()=>{
  wvdeHeader.textContent="WVDE data unavailable.";
});
</script>

</body>
</html>
